<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wasm Bptree Example</title>
    <script type="module">
        import init, { Store, ReadWriteTransaction, ReadOnlyTransaction } from './pkg/js_concread.js';
        // import { blake3 } from 'https://cdn.skypack.dev/@noble/hashes/blake3';
        // import { bytesToHex } from 'https://cdn.skypack.dev/@noble/hashes/utils';

        async function run() {
            await init();

            
            const tree = new Store();
            
            // const N = 1024 * 2048
            // // const N = 512
            // for (let i = 0; i < N; i++) {
            //     const key = blake3(i.toString(), { dkLen: 8 })
            //     tree.insert(bytesToHex(key), "")
            // }

            // console.log("inserted", N, "entries")

            {
                const txn = new ReadWriteTransaction(tree.create_write_transaction());
                txn.set("key1", "value1");
                txn.set("key2", "value2");
                txn.commit();
            }
            
            const snapshot = new ReadOnlyTransaction(tree.create_read_transaction());
            try {
                console.log("Initial reads:");
                console.log("key1:", snapshot.get("key1"));
                console.log("key2:", snapshot.get("key2"));

                {
                    const txn = new ReadWriteTransaction(tree.create_write_transaction());
                    txn.set("key3", "value3");
                    console.log("Reads after inserting key3:");
                    console.log("key1:", txn.get("key1"));
                    console.log("key2:", txn.get("key2"));
                    console.log("key3:", txn.get("key3"));
                    txn.commit();
                }
                
                console.log("Reads from snapshot:");
                console.log("key1:", snapshot.get("key1"));
                console.log("key2:", snapshot.get("key2"));
                console.log("key3:", snapshot.get("key3")); // Should not see key3

            } finally {
                snapshot.abort()
            }

            {
                console.log("Reads from final txn :");
                const txn = new ReadOnlyTransaction(tree.create_read_transaction());
                console.log("key3:", txn.get("key3")); // Should see key3
                txn.abort()
            }
        }

        run();
    </script>
</head>
<body>
    <h1>Wasm Bptree Example</h1>
</body>
</html>
